#!/usr/bin/env bash

BPM_WINDOW_ID=""
BPM_OUTPUT="DP-1"

enter_bpm() {
    echo "BPM entered"
    niri msg output "Dell Inc. DELL U2719D 7N8WTS2" transform normal
}

exit_bpm() {
    echo "BPM exited"
    niri msg output "Dell Inc. DELL U2719D 7N8WTS2" transform 270
    BPM_WINDOW_ID=""
}

niri msg --json event-stream | while read -r line; do
    # Only process WindowOpenedOrChanged / WindowClosed events
    event_type=$(echo "$line" | jq -r 'keys[0]')

    case "$event_type" in
        "WindowOpenedOrChanged")
            title=$(echo "$line" | jq -r '.WindowOpenedOrChanged.window.title')
            id=$(echo "$line" | jq -r '.WindowOpenedOrChanged.window.id')
            if [[ "$title" == "Steam Big Picture Mode" ]]; then
                BPM_WINDOW_ID="$id"
                enter_bpm
            fi
            ;;
        "WindowClosed")
            id=$(echo "$line" | jq -r '.WindowClosed.id')
            if [[ "$id" == "$BPM_WINDOW_ID" ]]; then
                exit_bpm
            fi
            ;;
    esac
done
