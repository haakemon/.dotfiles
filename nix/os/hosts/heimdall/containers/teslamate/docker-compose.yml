version: "3.9"

x-common-app-config: &common-app-config
  restart: unless-stopped
  environment:
    - TZ=$TZ
    - TIME_ZONE=$TZ

networks:
  default:
    driver: bridge

volumes:
  teslamate-grafana-data:

########################### SERVICES
services:
  teslamate:
    <<: *common-app-config
    container_name: teslamate
    image: teslamate/teslamate:1.32.0@sha256:8c282ada5c72b7b0cbd316ec7bc010a9214d5943cf1e1b36ab9b7a98f45a5809
    ports:
      - 127.0.0.1:4000:4000
    environment:
      ENCRYPTION_KEY: $TESLAMATE_ENCRYPTION_KEY
      DATABASE_USER: $TESLAMATE_DB_USER
      DATABASE_PASS: $TESLAMATE_DB_PASS
      DATABASE_NAME: $TESLAMATE_DB_NAME
      DATABASE_HOST: teslamate_database
      MQTT_USERNAME: $TESLAMATE_MQTT_USERNAME
      MQTT_PASSWORD: $TESLAMATE_MQTT_PASSWORD
      MQTT_HOST: host.containers.internal
      TZ: $TZ
    cap_drop:
      - all

  teslamate_grafana:
    <<: *common-app-config
    container_name: teslamate-grafana
    image: teslamate/grafana:1.32.0@sha256:76b8d0599b552e517df406805183b4ef578bc74cee8bcd147ab8698057d63629
    ports:
      - 127.0.0.1:4001:3000
    environment:
      DATABASE_USER: $TESLAMATE_DB_USER
      DATABASE_PASS: $TESLAMATE_DB_PASS
      DATABASE_NAME: $TESLAMATE_DB_NAME
      DATABASE_HOST: teslamate_database
      TZ: $TZ
    volumes:
      - teslamate-grafana-data:/var/lib/grafana

  teslamate_database:
    <<: *common-app-config
    container_name: teslamate-database
    image: postgres:16.6@sha256:c7afedc5c15994625b5be4cb4736c030271b55be0360b78a99c90ec2fbe658b6
    environment:
      POSTGRES_USER: $TESLAMATE_DB_USER
      POSTGRES_PASSWORD: $TESLAMATE_DB_PASS
      POSTGRES_DB: $TESLAMATE_DB_NAME
      PUID: $PUID
      PGID: $PGID
      TZ: $TZ
    volumes:
      - "$DATADIR/teslamate/db_16:/var/lib/postgresql/data"
